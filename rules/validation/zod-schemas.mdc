---
description:
globs:
alwaysApply: false
---
# Zod ÅemalarÄ± KurallarÄ±

## ğŸ¯ Kural Tipi YapÄ±landÄ±rmasÄ±

### Birincil Kural Tipi SeÃ§imi
- [x] Her zaman: ÅemalarÄ±n tutarlÄ± olmasÄ± gerektiÄŸi iÃ§in
- [ ] Manuel
- [ ] Otomatik EklenmiÅŸ
- [ ] Ajan TarafÄ±ndan Ä°stenen

type: always
description: Uygulama genelinde veri doÄŸrulamasÄ± iÃ§in kullanÄ±lacak Zod ÅŸemalarÄ±nÄ± merkezi olarak tanÄ±mlar.
globs: server/validation/**/*.schema.ts, types/schemas/**/*.schema.ts # Proje yapÄ±sÄ±na gÃ¶re ayarlanabilir

## ğŸ“‹ Sorumluluklar

### Åema TanÄ±mlama
- Her ana veri modeli (Ã¶rn. User, Product) iÃ§in ayrÄ± `.schema.ts` dosyalarÄ± oluÅŸturun.
- Temel Zod tiplerini (`z.string()`, `z.number()`, `z.boolean()`, `z.date()`, `z.enum()`, `z.object()`, `z.array()`) kullanÄ±n.
- `@types-schema-models.mdc` iÃ§indeki TypeScript arayÃ¼zleri/tipleri ile tutarlÄ± ÅŸemalar oluÅŸturun.
- Ã–zellikle `z.infer<typeof Schema>` kullanarak tipleri Zod ÅŸemalarÄ±ndan tÃ¼retmeyi dÃ¼ÅŸÃ¼nÃ¼n (@types-schema-models.mdc iÃ§inde belirtildiÄŸi gibi).

### DoÄŸrulama KurallarÄ±
- Zincirleme metotlarla (`.min()`, `.max()`, `.email()`, `.url()`, `.optional()`, `.nullable()`, `.default()`) doÄŸrulama kurallarÄ± ekleyin.
- Ã–zel hata mesajlarÄ± tanÄ±mlayÄ±n (Ã¶rn. `z.string().min(1, { message: "Bu alan zorunludur" })`).
- KarmaÅŸÄ±k veya koÅŸullu doÄŸrulama iÃ§in `.refine()` veya `.superRefine()` kullanÄ±n.
- ÅemalarÄ± `.extend()` ile geniÅŸletin veya `.pick()`, `.omit()` ile belirli alanlarÄ± seÃ§in/Ã§Ä±karÄ±n (Ã¶rn. Create vs Update ÅŸemalarÄ±).
- Åifre gibi alanlar iÃ§in `.transform()` kullanarak otomatik hashleme gibi iÅŸlemler eklemeyi dÃ¼ÅŸÃ¼nÃ¼n (dikkatli kullanÄ±lmalÄ±).

### Tekrar KullanÄ±m
- Ortak kullanÄ±lan ÅŸema parÃ§alarÄ±nÄ± (Ã¶rn. pagination, address) ayrÄ± ÅŸemalar olarak tanÄ±mlayÄ±p diÄŸer ÅŸemalarÄ±n iÃ§inde kullanÄ±n.
- Temel bir varlÄ±k ÅŸemasÄ± (`BaseSchema`) oluÅŸturup diÄŸerlerini bundan tÃ¼retin.

## ğŸ§© Anahtar BileÅŸenler
- Temel Åemalar: Ana veri modelleri iÃ§in temel doÄŸrulama kurallarÄ±.
- TÃ¼retilmiÅŸ Åemalar: OluÅŸturma (Create), GÃ¼ncelleme (Update) gibi Ã¶zel durumlar iÃ§in `.pick()`, `.omit()`, `.extend()` ile oluÅŸturulan ÅŸemalar.
- Ortak Åemalar: Birden fazla yerde kullanÄ±lan adres, sayfalama gibi yapÄ±lar iÃ§in ÅŸemalar.
- Refinements (`.refine`): Alanlar arasÄ± veya karmaÅŸÄ±k Ã¶zel doÄŸrulamalar.

## ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar

### Gerekli Paketler
- `zod`: ^3.x.x (veya projenin kullandÄ±ÄŸÄ± sÃ¼rÃ¼m)

### Gerekli Kurallar
- @types-schema-models.mdc (TypeScript tipleri/arayÃ¼zleri iÃ§in referans)

## âœ… DoÄŸru KullanÄ±m
```typescript
// types/schemas/base.schema.ts
import { z } from 'zod';

export const ObjectIdSchema = z.string().regex(/^[0-9a-fA-F]{24}$/, "GeÃ§ersiz ID formatÄ±");

export const BaseSchema = z.object({
  _id: ObjectIdSchema.optional(), // Veya veritabanÄ± modeline gÃ¶re
  createdAt: z.date().optional(),
  updatedAt: z.date().optional(),
});

// types/schemas/user.schema.ts veya server/validation/user.schema.ts
import { z } from 'zod';
import { BaseSchema } from './base.schema';
import { UserRole } from '@/types/shared.types'; // @types-schema-models.mdc'den

// Temel KullanÄ±cÄ± ÅemasÄ± (VeritabanÄ± veya tam model)
export const UserSchema = BaseSchema.extend({
  name: z.string().min(1, "Ä°sim gereklidir").trim(),
  email: z.string().email("GeÃ§ersiz e-posta").toLowerCase().trim(),
  password: z.string().min(8, "Åifre en az 8 karakter olmalÄ±"),
  role: z.nativeEnum(UserRole).default(UserRole.Viewer),
  isActive: z.boolean().optional().default(true),
});

// API'de KullanÄ±cÄ± OluÅŸturma ÅemasÄ±
export const UserCreateAPISchema = UserSchema.omit({ 
  _id: true, 
  createdAt: true, 
  updatedAt: true, 
  isActive: true // Genellikle oluÅŸturmada default olur
});

// API'de KullanÄ±cÄ± GÃ¼ncelleme ÅemasÄ± (TÃ¼m alanlar isteÄŸe baÄŸlÄ±)
export const UserUpdateAPISchema = UserCreateAPISchema.partial();

// Åifre DoÄŸrulama ile Refine Ã–rneÄŸi
export const UserRegisterSchema = UserCreateAPISchema.extend({
    passwordConfirm: z.string().min(8, "Åifre tekrarÄ± en az 8 karakter olmalÄ±")
}).refine(data => data.password === data.passwordConfirm, {
    message: "Åifreler eÅŸleÅŸmiyor",
    path: ["passwordConfirm"], // HatanÄ±n hangi alana ait olduÄŸunu belirtir
});

// TypeScript Tipi TÃ¼retme
export type IUser = z.infer<typeof UserSchema>;
export type IUserCreateAPI = z.infer<typeof UserCreateAPISchema>;

// KullanÄ±m (API Endpoint - @api-endpoints.mdc iÃ§inde)
// import { UserCreateAPISchema } from '@/server/validation/user.schema';
// const body = await readValidatedBody(event, data => UserCreateAPISchema.safeParse(data));
// if (!body.success) { throw createError({ ... }); }
// const validatedData = body.data;
```

## âŒ YanlÄ±ÅŸ KullanÄ±m
```typescript
// âŒ YANLIÅ: DoÄŸrulama mantÄ±ÄŸÄ±nÄ± API endpoint'lerine veya component'lere daÄŸÄ±tmak
// Her yerde ayrÄ± ayrÄ± `if (body.email && !body.email.includes('@'))` kontrolleri yapmak.

// âŒ YANLIÅ: ÅemalarÄ± tekrar tekrar tanÄ±mlamak
// Hem API create hem de update iÃ§in aynÄ± alanlarÄ± kopyala-yapÄ±ÅŸtÄ±r yapmak.

// âŒ YANLIÅ: AÅŸÄ±rÄ± karmaÅŸÄ±k tek bir ÅŸema kullanmak
// `.optional()` ve `.default()` ile dolu devasa bir ÅŸema yerine create/update iÃ§in ayrÄ± ÅŸemalar daha okunaklÄ±dÄ±r.

// âŒ YANLIÅ: Tipleri Zod ÅŸemalarÄ±ndan ayrÄ± yÃ¶netmek (senkronizasyon sorunu)
// interface IUser { email: string; } ayrÄ±, UserSchema = z.object({ email: z.string() }) ayrÄ± tanÄ±mlanÄ±rsa tutarsÄ±zlÄ±k olabilir. z.infer kullanmak daha iyi.
```

## ğŸ” Kontrol Listesi

### Kod Kalitesi
- [ ] Åemalar mantÄ±ksal olarak ayrÄ± dosyalarda mÄ± (`*.schema.ts`)?
- [ ] Åemalar `@types-schema-models.mdc` ile tutarlÄ± mÄ± veya tipler `z.infer` ile mi tÃ¼retilmiÅŸ?
- [ ] Tekrar eden ÅŸema parÃ§alarÄ± ayrÄ±/ortak ÅŸemalarla yÃ¶netiliyor mu?
- [ ] Create/Update gibi durumlar iÃ§in tÃ¼retilmiÅŸ ÅŸemalar kullanÄ±lÄ±yor mu (`pick`, `omit`, `partial`)?
- [ ] Ã–zel hata mesajlarÄ± anlaÅŸÄ±lÄ±r mÄ±?
- [ ] `.refine` kullanÄ±mÄ± mantÄ±klÄ± ve gerekli mi?

### Teknik Gereksinimler
- [ ] Åemalar uygulamanÄ±n ihtiyaÃ§ duyduÄŸu tÃ¼m doÄŸrulamalarÄ± kapsÄ±yor mu?
- [ ] PerformansÄ± etkileyecek aÅŸÄ±rÄ± karmaÅŸÄ±k `refine`'lardan kaÃ§Ä±nÄ±lmÄ±ÅŸ mÄ±?

## ğŸ“ Kural Ä°Ã§eriÄŸi YÃ¶nergeleri
- Temel Zod kullanÄ±mÄ± ve yaygÄ±n metotlarla baÅŸlayÄ±n.
- `@types-schema-models.mdc` ile nasÄ±l entegre olunacaÄŸÄ±nÄ± gÃ¶sterin (`z.infer` vurgusu).
- Create/Update/Partial ÅŸemalarÄ±n nasÄ±l oluÅŸturulacaÄŸÄ±nÄ± Ã¶rnekleyin (`pick`, `omit`, `partial`).
- `.refine` ile Ã¶zel doÄŸrulama Ã¶rnekleri verin.
- Ortak ÅŸemalarÄ±n tekrar kullanÄ±mÄ± prensibini aÃ§Ä±klayÄ±n.

## ğŸ”„ Kural BakÄ±mÄ±
- Yeni Zod sÃ¼rÃ¼mleri Ã§Ä±ktÄ±kÃ§a veya yeni doÄŸrulama desenleri popÃ¼lerleÅŸtikÃ§e gÃ¼ncelleyin.
- Projedeki veri modelleri deÄŸiÅŸtikÃ§e ilgili ÅŸemalarÄ± gÃ¼ncelleyin.

## ğŸ§ª Testler
- [ ] Her ÅŸema iÃ§in birim testleri yazÄ±n.
- [ ] GeÃ§erli ve geÃ§ersiz verilerle tÃ¼m doÄŸrulama kurallarÄ±nÄ± (`min`, `max`, `email`, `refine` vb.) test edin.
- [ ] Ã–zel hata mesajlarÄ±nÄ±n doÄŸru dÃ¶ndÃ¼ÄŸÃ¼nÃ¼ test edin.
- [ ] TÃ¼retilmiÅŸ ÅŸemalarÄ±n (`pick`, `omit`, `partial`) beklendiÄŸi gibi Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± test edin.

## ğŸ’¡ Ä°puÃ§larÄ±
- ÅemalarÄ± olabildiÄŸince basit tutun, karmaÅŸÄ±klÄ±ÄŸÄ± `.refine` veya tÃ¼retilmiÅŸ ÅŸemalarla yÃ¶netin.
- Formlarla entegrasyon iÃ§in (bkz: `@form-validation.mdc`), form kÃ¼tÃ¼phanesinin Zod adaptÃ¶rÃ¼nÃ¼ kullanmayÄ± dÃ¼ÅŸÃ¼nÃ¼n.
- `z.preprocess` ile veriyi doÄŸrulamadan Ã¶nce dÃ¶nÃ¼ÅŸtÃ¼rebilirsiniz (Ã¶rn. string'i sayÄ±ya Ã§evirme), ancak dikkatli kullanÄ±n.
- `z.union` veya `z.discriminatedUnion` ile farklÄ± ÅŸekillere sahip olabilecek verileri modelleyin.

## ğŸ”— Ä°stemci ve Sunucu TarafÄ± DoÄŸrulama Ä°liÅŸkisi

Zod ÅŸemalarÄ± hem istemci tarafÄ±nda (Nuxt UI formlarÄ± ile `<UForm :schema>`) hem de sunucu tarafÄ±nda (API endpoint'lerinde `schema.safeParse()`) kullanÄ±lmalÄ±dÄ±r.

*   **Ä°stemci TarafÄ±:** `<UForm>`, gÃ¶nderim *Ã¶ncesinde* ÅŸemayÄ± kullanarak anÄ±nda geri bildirim saÄŸlar. Bu, gereksiz API Ã§aÄŸrÄ±larÄ±nÄ± Ã¶nler ve kullanÄ±cÄ± deneyimini iyileÅŸtirir.
*   **Sunucu TarafÄ±:** GÃ¼venlik ve veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in **her zaman** sunucu tarafÄ±nda da doÄŸrulama yapÄ±lmalÄ±dÄ±r. Ä°stemci tarafÄ± doÄŸrulamasÄ± atlatÄ±labilir.

## âš ï¸ Sunucu TarafÄ± DoÄŸrulama HatalarÄ±nÄ± Ä°ÅŸleme

API endpoint'i, sunucu tarafÄ± Zod doÄŸrulamasÄ± baÅŸarÄ±sÄ±z olduÄŸunda, `api-endpoints.mdc` kuralÄ±nda belirtildiÄŸi gibi **standart bir hata yanÄ±tÄ±** dÃ¶nmelidir:

```json
// Ã–rnek Hata YanÄ±tÄ± (statusCode: 400)
{
  "code": "VALIDATION_ERROR",
  "message": "GÃ¶nderilen veriler geÃ§ersiz.",
  "details": {
    "name": ["Ä°sim alanÄ± en az 3 karakter olmalÄ±dÄ±r."],
    "email": ["GeÃ§ersiz e-posta adresi."]
    // ... diÄŸer alan hatalarÄ±
  }
}
```

Bu yanÄ±tÄ±n `details` alanÄ±, Zod'un `error.flatten().fieldErrors` Ã§Ä±ktÄ±sÄ±yla aynÄ± yapÄ±da olmalÄ±dÄ±r (alan adÄ± -> hata mesajÄ± dizisi).

Ä°stemci tarafÄ±nda (`useFormHandler` veya `displayFormError` iÃ§inde), bu `VALIDATION_ERROR` kodu ve `details` alanÄ± kullanÄ±larak `<UForm>`'un `setErrors` metodu Ã§aÄŸrÄ±lÄ±r:

```typescript
// (useFormHandler onError callback veya watch bloÄŸu iÃ§inde)

if (error.code === 'VALIDATION_ERROR' && error.details && typeof error.details === 'object') {
  const fieldErrors = Object.entries(error.details).map(([key, value]) => ({
    path: key, // Zod ÅŸemasÄ±ndaki alan adÄ± ile eÅŸleÅŸmeli
    message: Array.isArray(value) ? value.join(', ') : String(value), // Ä°lk veya birleÅŸtirilmiÅŸ mesaj
  }));
  formRef.value?.setErrors(fieldErrors);
}
```

Bu sayede, sunucudan dÃ¶nen doÄŸrulama hatalarÄ± da doÄŸrudan formdaki ilgili alanlarÄ±n altÄ±nda gÃ¶sterilir.

## ğŸ“Œ Ã–nemli Notlar

*   **Tek Kaynak:** MÃ¼mkÃ¼nse, aynÄ± veri yapÄ±sÄ± iÃ§in hem istemci hem de sunucu tarafÄ±nda **aynÄ± Zod ÅŸemasÄ±nÄ±** kullanÄ±n. Bu, tutarlÄ±lÄ±ÄŸÄ± saÄŸlar ve tekrarÄ± azaltÄ±r. ÅemalarÄ± `types` veya paylaÅŸÄ±lan bir dizinde tanÄ±mlayÄ±p her iki taraftan da import edebilirsiniz.
*   **Hassas Veri:** Sunucudan istemciye hata detaylarÄ±nÄ± (`details`) gÃ¶nderirken hassas bilgilerin (Ã¶rn. veritabanÄ± detaylarÄ±) sÄ±zdÄ±rÄ±lmadÄ±ÄŸÄ±ndan emin olun. Sadece doÄŸrulama mesajlarÄ±nÄ± gÃ¶nderin.
