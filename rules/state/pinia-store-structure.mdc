---
description: 
globs: 
alwaysApply: false
---
# Pinia Store YapÄ±sÄ± KurallarÄ± (Setup Stili)

## ğŸ¯ Kural Tipi YapÄ±landÄ±rmasÄ±

### Birincil Kural Tipi SeÃ§imi
- [x] Her zaman: State yÃ¶netimi tutarlÄ±lÄ±ÄŸÄ± iÃ§in
- [ ] Manuel
- [ ] Otomatik EklenmiÅŸ
- [ ] Ajan TarafÄ±ndan Ä°stenen

type: always
description: Nuxt/Vue projelerinde Pinia state yÃ¶netimi iÃ§in "Setup Store" stilinin kullanÄ±mÄ±nÄ± standartlaÅŸtÄ±rÄ±r.
globs: stores/**/*.ts, store/**/*.ts # Proje yapÄ±sÄ±na gÃ¶re ayarlanabilir

## ğŸ“‹ Sorumluluklar

### Store TanÄ±mlama
- Her store iÃ§in ayrÄ± bir `.ts` dosyasÄ± oluÅŸturun (Ã¶rn. `user.store.ts`).
- Store tanÄ±mlamak iÃ§in `defineStore` fonksiyonunu kullanÄ±n.
- Ä°lk argÃ¼man olarak store iÃ§in benzersiz bir ID (string) verin (genellikle dosya adÄ±yla aynÄ± veya benzer).
- Ä°kinci argÃ¼man olarak bir setup fonksiyonu (`() => { ... }`) kullanÄ±n.

### State TanÄ±mlama
- Store state'ini temsil eden deÄŸiÅŸkenleri `ref()` ile tanÄ±mlayÄ±n.
- Hata YÃ¶netimi Ä°Ã§in: Asenkron action'larÄ±n hatalarÄ±nÄ± tutmak iÃ§in standartlaÅŸtÄ±rÄ±lmÄ±ÅŸ bir `error` state'i (`ref<IApiError | null>(null)`) ekleyin.
- Bu ref'leri setup fonksiyonu iÃ§inden return edin.

### Getters TanÄ±mlama
- Hesaplanan state deÄŸerleri iÃ§in `computed()` kullanÄ±n.
- Bu computed ref'leri setup fonksiyonu iÃ§inden return edin.

### Actions TanÄ±mlama
- State'i deÄŸiÅŸtirecek mantÄ±ÄŸÄ± iÃ§eren fonksiyonlarÄ± doÄŸrudan setup fonksiyonu iÃ§inde tanÄ±mlayÄ±n.
- Asenkron Ä°ÅŸlemler ve Hata YÃ¶netimi:
    - Asenkron iÅŸlemleri (API Ã§aÄŸrÄ±larÄ± vb.) iÃ§eren action'larÄ± `async` olarak tanÄ±mlayÄ±n.
    - Asenkron kodlarÄ± `try...catch` bloÄŸu iÃ§ine alÄ±n.
    - `catch` bloÄŸunda, hatayÄ± `normalizeError` fonksiyonu ile standartlaÅŸtÄ±rÄ±n ve store'daki `error` ref'ini bu normalleÅŸtirilmiÅŸ hata ile gÃ¼ncelleyin.
    - Action'Ä±n baÅŸarÄ±lÄ± olup olmadÄ±ÄŸÄ±nÄ± belirtmek iÃ§in `true`/`false` dÃ¶nebilirsiniz.
    - `finally` bloÄŸunu kullanarak yÃ¼kleme durumu (loading state) gibi durumlarÄ± temizleyebilirsiniz.
- Actions iÃ§inde diÄŸer actionlarÄ± Ã§aÄŸÄ±rabilirsiniz.
- Actions iÃ§inde state ref'lerinin `.value` Ã¶zelliÄŸini kullanarak state'i deÄŸiÅŸtirin.
- Bu fonksiyonlarÄ± setup fonksiyonu iÃ§inden return edin.

### DÄ±ÅŸa Aktarma (Return)
- Setup fonksiyonundan state ref'lerini, computed ref'lerini (getters) ve action fonksiyonlarÄ±nÄ± iÃ§eren bir obje return edin.
- DÄ±ÅŸa aktarÄ±lmayan (return edilmeyen) deÄŸiÅŸkenler veya fonksiyonlar store'un Ã¶zel (private) Ã¼yeleri olarak kalÄ±r.

### Ä°simlendirme
- Store dosya isimleri genellikle `*.store.ts` veya `*Store.ts` ÅŸeklinde olur.
- `defineStore` ile oluÅŸturulan store deÄŸiÅŸkeni `use` Ã¶n eki ve PascalCase isimlendirme ile tanÄ±mlanÄ±r (Ã¶rn. `useUserStore`).

### TypeScript
- MÃ¼mkÃ¼nse `ref<Type>()` ve `computed<Type>(...)` kullanarak tipleri belirtin.
- Return edilen objenin tipi otomatik olarak Ã§Ä±karÄ±lÄ±r, ancak karmaÅŸÄ±k durumlarda aÃ§Ä±kÃ§a belirtilebilir.

### Store KullanÄ±mÄ± (Component Ä°Ã§inde)
- Component setup'Ä±nda store'u `useMyStore()` ÅŸeklinde Ã§aÄŸÄ±rÄ±n.
- Reaktiviteyi korumak iÃ§in state ve getter'larÄ± component template'inde kullanÄ±rken `storeToRefs(store)` yardÄ±mcÄ± fonksiyonunu kullanÄ±n.
- Action'larÄ± doÄŸrudan store objesinden Ã§aÄŸÄ±rÄ±n (`store.increment()`).

## ğŸ§© Anahtar BileÅŸenler
- `defineStore`: Store tanÄ±mlama fonksiyonu.
- `ref`: Reaktif state deÄŸiÅŸkenleri.
- `computed`: Hesaplanan state (getters).
- Fonksiyonlar: State deÄŸiÅŸtiren mantÄ±k (actions).
- `return { ... }`: Store'un public arayÃ¼zÃ¼nÃ¼ (state, getters, actions) tanÄ±mlar.
- `storeToRefs`: Component iÃ§inde reaktiviteyi korumak iÃ§in.
- `error` State (`ref<IApiError | null>`): Store kaynaklÄ±, standartlaÅŸtÄ±rÄ±lmÄ±ÅŸ hatalarÄ± tutmak iÃ§in.
- `normalizeError` (Helper Fonksiyon): HatalarÄ± standart `IApiError` formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in (Ã¶nerilen).

## ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar

### Gerekli Paketler
- `vue`: ^3.x.x
- `pinia`: ^2.x.x (veya projenin kullandÄ±ÄŸÄ± sÃ¼rÃ¼m)
- `@pinia/nuxt`: (Nuxt projeleri iÃ§in genellikle otomatik yÃ¼klenir)

### Gerekli Kurallar
- Belki @types-schema-models.mdc (State tipleri iÃ§in)

## âœ… DoÄŸru KullanÄ±m
```typescript
// stores/user.store.ts
import { ref, computed } from 'vue';
import { defineStore, acceptHMRUpdate } from 'pinia';
import type { IUser, IApiError } from '@/types/shared.types'; // Ã–rnek tipler
import { normalizeError } from '@/utils/errorHelper'; // PaylaÅŸÄ±lan helper
import { $fetch, FetchError } from 'ofetch';

export const useUserStore = defineStore('user', () => {
  // State
  const user = ref<IUser | null>(null);
  const loading = ref(false);
  const error = ref<IApiError | null>(null); // StandartlaÅŸtÄ±rÄ±lmÄ±ÅŸ hata state'i

  // Getters
  const isLoggedIn = computed(() => !!user.value);
  const userName = computed(() => user.value?.name || 'Guest');

  // Actions
  async function fetchUser(id: string): Promise<boolean> { // BaÅŸarÄ± durumunu dÃ¶ndÃ¼r
    loading.value = true;
    error.value = null; // Ã–nceki hatayÄ± temizle
    try {
      const fetchedData = await $fetch<IUser>(`/api/users/${id}`);
      user.value = fetchedData;
      return true; // BaÅŸarÄ±lÄ±
    } catch (err: unknown) { // Hata tipini unknown olarak yakala
      // HatayÄ± standart formata dÃ¶nÃ¼ÅŸtÃ¼r ve state'e kaydet
      error.value = normalizeError(err);
      user.value = null; // KullanÄ±cÄ± verisini temizle
      console.error("fetchUser Error:", err); // Orijinal hatayÄ± logla
      return false; // BaÅŸarÄ±sÄ±z
    } finally {
      loading.value = false;
    }
  }

  function clearUser() {
    user.value = null;
    error.value = null;
  }

  function $reset() {
    user.value = null;
    loading.value = false;
    error.value = null;
  }

  // DÄ±ÅŸa AktarÄ±lacaklar
  return {
    // State
    user,
    loading,
    error, // StandartlaÅŸtÄ±rÄ±lmÄ±ÅŸ hata state'i
    // Getters
    isLoggedIn,
    userName,
    // Actions
    fetchUser,
    clearUser,
    $reset,
  };
});

// HMR DesteÄŸi (Ä°steÄŸe BaÄŸlÄ± ama Ã–nerilen)
if (import.meta.hot) {
  import.meta.hot.accept(acceptHMRUpdate(useUserStore, import.meta.hot));
}

// ----- Component Ä°Ã§inde KullanÄ±m ----- 
/*
<script setup lang="ts">
import { useUserStore } from '@/stores/user.store';
import { storeToRefs } from 'pinia';
import { onMounted } from 'vue';

const userStore = useUserStore();
// ArtÄ±k error objesinin .message ve .code gibi alanlarÄ± olacaÄŸÄ±nÄ± biliyoruz
const { user, loading, error, userName } = storeToRefs(userStore);

async function loadUser() {
    const success = await userStore.fetchUser('123');
    if (!success && error.value) {
        console.error(`[${error.value.code}] ${error.value.message}`);
    }
}

onMounted(() => { loadUser(); });
</script>

<template>
  <div>
    <p v-if="loading">YÃ¼kleniyor...</p>
    <!-- Hata mesajÄ±nÄ± standart objeden gÃ¶ster -->
    <div v-else-if="error" style="color: red;">Hata: {{ error.message }} (Kod: {{ error.code }})</div>
    <div v-else-if="user">
      <p>HoÅŸgeldin, {{ userName }}</p>
    </div>
    <p v-else>KullanÄ±cÄ± bulunamadÄ± veya yÃ¼klenemedi.</p>
    <button @click="loadUser" :disabled="loading">Tekrar YÃ¼kle</button>
    <button @click="userStore.clearUser">KullanÄ±cÄ±yÄ± Temizle</button>
  </div>
</template>
*/
```

## âŒ YanlÄ±ÅŸ KullanÄ±m
```typescript
// âŒ YANLIÅ: Setup fonksiyonu dÄ±ÅŸÄ±nda deÄŸiÅŸken tanÄ±mlama
// let myVar = 10;
export const useMyStore = defineStore('myStore', () => {
  // ...
});

// âŒ YANLIÅ: State iÃ§in `reactive()` kullanmak (ref tercih edilir)
// const state = reactive({ count: 0 });

// âŒ YANLIÅ: Actions iÃ§inde `this` kullanmak
/*
function increment() {
  this.count++; // YANLIÅ
}
*/

// âŒ YANLIÅ: State veya Getter'larÄ± component iÃ§inde storeToRefs olmadan destructure etmek
/*
<script setup>
  const counterStore = useCounterStore();
  const { count } = counterStore; // YANLIÅ - Reaktivite kaybolur
</script>
*/

// âŒ YANLIÅ: Store iÃ§inde baÅŸka bir store'u setup anÄ±nda doÄŸrudan okumak (sonsuz dÃ¶ngÃ¼ riski)
/*
export const useStoreA = defineStore('storeA', () => {
  const storeB = useStoreB();
  const initialBValue = storeB.someValue; // âŒ RÄ°SKLÄ° - EÄŸer StoreB de StoreA'yÄ± okuyorsa
  // ...
});
*/
// DoÄŸrusu: BaÅŸka store deÄŸerlerini action veya computed iÃ§inde okuyun.

```

## ğŸ” Kontrol Listesi

### Kod Kalitesi
- [ ] Store ID benzersiz ve string mi?
- [ ] Setup fonksiyonu (`() => {}`) kullanÄ±lÄ±yor mu?
- [ ] State iÃ§in `ref()` kullanÄ±lÄ±yor mu?
- [ ] Getterlar iÃ§in `computed()` kullanÄ±lÄ±yor mu?
- [ ] Actionlar dÃ¼z fonksiyon olarak mÄ± tanÄ±mlanmÄ±ÅŸ?
- [ ] Actionlar iÃ§inde state `.value` ile mi deÄŸiÅŸtiriliyor?
- [ ] Gerekli state, getter ve actionlar setup fonksiyonundan return ediliyor mu?
- [ ] Store ismi `useMyStore` formatÄ±nda mÄ±?
- [ ] Component iÃ§inde state/getterlar `storeToRefs` ile mi alÄ±nÄ±yor?

### Teknik Gereksinimler
- [ ] TypeScript tipleri (varsa) doÄŸru kullanÄ±lmÄ±ÅŸ mÄ±?
- [ ] HMR desteÄŸi eklenmiÅŸ mi (Ã¶nerilir)?
- [ ] Storelar arasÄ± dÃ¶ngÃ¼sel baÄŸÄ±mlÄ±lÄ±klardan kaÃ§Ä±nÄ±lmÄ±ÅŸ mÄ±?

## ğŸ“ Kural Ä°Ã§eriÄŸi YÃ¶nergeleri
- `defineStore` ile setup store tanÄ±mÄ±nÄ± aÃ§Ä±klayÄ±n.
- `ref`, `computed` ve fonksiyonlarÄ±n state, getter, action olarak nasÄ±l kullanÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶sterin.
- `return` ifadesinin store'un public arayÃ¼zÃ¼nÃ¼ nasÄ±l belirlediÄŸini vurgulayÄ±n.
- Component iÃ§inde `useMyStore()` ve `storeToRefs()` kullanÄ±mÄ±nÄ± Ã¶rnekleyin.
- HMR desteÄŸinin nasÄ±l ekleneceÄŸini gÃ¶sterin.

## ğŸ”„ Kural BakÄ±mÄ±
- Yeni Pinia sÃ¼rÃ¼mleriyle gelen Ã¶zellikleri (Ã¶rn. yeni helperlar) ekleyin.
- Setup store ile ilgili yaygÄ±n desenleri veya potansiyel sorunlarÄ± (Ã¶rn. store kompozisyonu) ekleyin.

## ğŸ§ª Testler
- Vitest veya benzeri bir araÃ§la:
  - [ ] Store'un baÅŸlangÄ±Ã§ state'ini test edin.
  - [ ] Action'larÄ±n state'i beklendiÄŸi gibi deÄŸiÅŸtirdiÄŸini test edin.
  - [ ] Getter'larÄ±n doÄŸru hesaplanmÄ±ÅŸ deÄŸerleri dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼nÃ¼ test edin.
  - [ ] FarklÄ± action Ã§aÄŸrÄ±mlarÄ±nÄ±n sonuÃ§larÄ±nÄ± test edin.
  - [ ] Varsa `$reset` metodunun state'i sÄ±fÄ±rladÄ±ÄŸÄ±nÄ± test edin.

## ğŸ’¡ Ä°puÃ§larÄ±
- Store mantÄ±ÄŸÄ±nÄ± kÃ¼Ã§Ã¼k ve odaklanmÄ±ÅŸ tutun. Ã‡ok fazla sorumluluk yÃ¼klemeyin.
- KarmaÅŸÄ±k veya tekrar eden action mantÄ±ÄŸÄ±nÄ± store dÄ±ÅŸÄ±na, composable fonksiyonlara taÅŸÄ±mayÄ± dÃ¼ÅŸÃ¼nÃ¼n.
- Store iÃ§inde global state yerine gerÃ§ekten global olmasÄ± gereken state'i tutun.
- Gerekirse, state sÄ±fÄ±rlama iÃ§in Ã¶zel bir `$reset` aksiyonu ekleyebilirsiniz.
- BaÅŸka bir store'a baÄŸÄ±mlÄ±lÄ±k varsa, onu action veya computed iÃ§inde Ã§aÄŸÄ±rarak kullanÄ±n, setup anÄ±nda doÄŸrudan state okumaktan kaÃ§Ä±nÄ±n.
- **Hata NormalleÅŸtirme:** FarklÄ± kaynaklardan gelen hatalarÄ± (`FetchError`, Ã¶zel hatalar, genel `Error`) tutarlÄ± bir `IApiError { code, message, details? }` yapÄ±sÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in paylaÅŸÄ±lan bir `normalizeError` yardÄ±mcÄ± fonksiyonu kullanÄ±n. Bu, hem store iÃ§indeki hem de UI katmanÄ±ndaki hata yÃ¶netimini basitleÅŸtirir.
  ```typescript
  // Ã–rnek: utils/errorHelper.ts
  import { FetchError } from 'ofetch';
  import { BaseError } from '@/errors/baseError'; // VarsayÄ±msal Ã¶zel hata sÄ±nÄ±fÄ±
  import type { IApiError } from '@/types/shared.types'; // VarsayÄ±msal arayÃ¼z

  export function normalizeError(error: unknown): IApiError {
      if (error instanceof BaseError) {
          return { code: error.code, message: error.message, details: error.details };
      }
      if (error instanceof FetchError) {
          if (error.data && typeof error.data === 'object' && 'code' in error.data && 'message' in error.data) {
              return error.data as IApiError; // API'den gelen yapÄ±ya gÃ¼ven
          }
          return { code: 'FETCH_ERROR', message: error.message || 'API isteÄŸi baÅŸarÄ±sÄ±z oldu.', details: { statusCode: error.statusCode } };
      }
      if (error instanceof Error) {
          return { code: 'INTERNAL_CLIENT_ERROR', message: error.message };
      }
      return { code: 'UNKNOWN_ERROR', message: 'Beklenmedik bir hata oluÅŸtu.' };
  }
  ```
- `IApiError` ve Ã¶zel `BaseError` gibi tipleri `@types-schema-models.mdc` veya benzeri paylaÅŸÄ±lan bir dosyada tanÄ±mlayÄ±n.
- API'den dÃ¶nen hata yapÄ±sÄ±nÄ± dikkate alarak `normalizeError` fonksiyonunu geliÅŸtirin.

