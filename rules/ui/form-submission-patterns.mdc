---
description:
globs:
alwaysApply: false
---
# @rule-template.mdc

# Kural: Form GÃ¶nderim Desenleri

**Dosya:** `rules/ui/form-submission-patterns.mdc`

**AÃ§Ä±klama:** Nuxt uygulamalarÄ±nda form gÃ¶nderim sÃ¼reÃ§lerinin (yÃ¼klenme durumu, baÅŸarÄ± ve hata bildirimleri) yÃ¶netimi iÃ§in standart desenleri tanÄ±mlar.

## ğŸ¯ AmaÃ§

*   KullanÄ±cÄ±ya form gÃ¶nderimi sÄ±rasÄ±nda net geri bildirim saÄŸlamak.
*   Tekrarlayan gÃ¶nderim mantÄ±ÄŸÄ±nÄ± azaltmak.
*   BaÅŸarÄ± ve hata durumlarÄ±nÄ± tutarlÄ± bir ÅŸekilde ele almak.

## âš™ï¸ Temel Desen

Form gÃ¶nderimi genellikle aÅŸaÄŸÄ±daki adÄ±mlarÄ± iÃ§erir:

1.  **BaÅŸlatma:** KullanÄ±cÄ± formu gÃ¶nderme eylemini tetikler (`<UForm @submit>`).
2.  **DoÄŸrulama:** `<UForm>` otomatik olarak Zod ÅŸemasÄ±yla doÄŸrulamayÄ± Ã§alÄ±ÅŸtÄ±rÄ±r.
3.  **YÃ¼klenme Durumu:** DoÄŸrulama baÅŸarÄ±lÄ±ysa, bir `loading` state'i `true` yapÄ±lÄ±r (genellikle butonu devre dÄ±ÅŸÄ± bÄ±rakmak ve/veya bir gÃ¶sterge gÃ¶stermek iÃ§in).
4.  **API Ã‡aÄŸrÄ±sÄ±:** Form verileri ilgili API endpoint'ine gÃ¶nderilir (genellikle Pinia action'Ä± aracÄ±lÄ±ÄŸÄ±yla).
5.  **SonuÃ§ Ä°ÅŸleme:**
    *   **BaÅŸarÄ±:** API Ã§aÄŸrÄ±sÄ± baÅŸarÄ±lÄ± olursa:
        *   KullanÄ±cÄ±ya baÅŸarÄ± mesajÄ± gÃ¶sterilir (Ã¶rn. `useToast().add()`).
        *   Gerekirse form sÄ±fÄ±rlanÄ±r veya kullanÄ±cÄ± baÅŸka bir sayfaya yÃ¶nlendirilir.
    *   **Hata:** API Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z olursa:
        *   Pinia store'dan dÃ¶nen veya doÄŸrudan yakalanan hata `normalizeError` ile iÅŸlenir.
        *   Genel hatalar formun Ã¼stÃ¼nde bir `<UAlert>` ile gÃ¶sterilir (`form-error-handling.mdc` kuralÄ±na bakÄ±n).
        *   Alan bazlÄ± hatalar (varsa ve `details` iÃ§inde geliyorsa) `<UForm>`'un `setErrors` metodu ile ilgili alanlara atanÄ±r (`form-error-handling.mdc` kuralÄ±na bakÄ±n).
6.  **YÃ¼klenme Durumunu Bitirme:** BaÅŸarÄ±lÄ± veya baÅŸarÄ±sÄ±z olsun, `loading` state'i `false` yapÄ±lÄ±r.

## âœ… Ã–rnek Uygulama (Composable ile)

Bu Ã¶rnek, `useFormHandler` composable'Ä±nÄ± kullanarak aynÄ± form gÃ¶nderim mantÄ±ÄŸÄ±nÄ± nasÄ±l daha temiz bir ÅŸekilde uygulayacaÄŸÄ±mÄ±zÄ± gÃ¶sterir.

```vue
<template>
  <UForm 
    ref="formRef" <!-- setErrors iÃ§in ref -->
    :state="state"
    :schema="schema"
    @submit="submit"
    class="space-y-4"
  >
    <!-- Genel Hata MesajÄ± AlanÄ± -->
    <UAlert
      v-if="formError"
      icon="i-heroicons-exclamation-triangle"
      color="red"
      variant="soft"
      :title="formError.message" <!-- Composable'dan gelen error state'i kullanÄ±lÄ±yor -->
      :description="formError.code !== 'VALIDATION_ERROR' ? formError.details?.value || formError.code : 'LÃ¼tfen formdaki hatalarÄ± dÃ¼zeltin.'"
      closable
      @close="formError = null" <!-- Hata manuel olarak kapatÄ±labilir -->
    />

    <UFormGroup label="Ä°sim" name="name">
      <UInput v-model="state.name" />
    </UFormGroup>

    <UFormGroup label="E-posta" name="email">
      <UInput v-model="state.email" type="email" />
    </UFormGroup>

    <!-- DiÄŸer form alanlarÄ±... -->

    <UButton 
      type="submit" 
      :loading="isLoading" <!-- Composable'dan gelen isLoading state'i kullanÄ±lÄ±yor -->
      label="Kaydet"
      />
  </UForm>
</template>

<script setup lang="ts">
import { ref, reactive, watch } from 'vue';
import { z } from 'zod';
import type { Form } from '#ui/types';
import { useMyFeatureStore } from '~/stores/myFeature';
import { useFormHandler } from '~/composables/useFormHandler'; // Composable import edildi
import type { IApiError } from '~/utils/error';

const store = useMyFeatureStore();
const toast = useToast();
const formRef = ref<Form<any>>(); 

// Ã–rnek State ve Åema
const state = reactive({
  name: '',
  email: '',
});

const schema = z.object({
  name: z.string().min(1, 'Ä°sim alanÄ± zorunludur.'),
  email: z.string().email('GeÃ§ersiz e-posta adresi.'),
});

type SchemaOutput = z.output<typeof schema>;
// Pinia action'Ä±nÄ±n dÃ¶nÃ¼ÅŸ tipi (baÅŸarÄ± durumunda)
// Ã–rnek: { id: string; message: string }
interface ApiSuccessResult {
  id: string;
  message: string;
}

// Composable'Ä± kullanma
const { isLoading, error: formError, submit } = useFormHandler<typeof schema, ApiSuccessResult>({
  schema, // Zod ÅŸemasÄ±
  // GÃ¶nderim fonksiyonu (Pinia action'Ä±nÄ± Ã§aÄŸÄ±rma)
  onSubmit: async (formData: SchemaOutput) => {
    // Not: Pinia action'Ä±nÄ±n artÄ±k sadece baÅŸarÄ± durumunda veri,
    // hata durumunda ise throw etmesi beklenir.
    // Veya Ã¶nceki gibi { success: boolean, ... } dÃ¶ndÃ¼rebilir,
    // o zaman burada kontrol gerekir.
    // Basitlik iÃ§in action'Ä±n throw ettiÄŸini varsayalÄ±m.
    formRef.value?.clear(); // Her gÃ¶nderim Ã¶ncesi eski hatalarÄ± temizle
    return await store.createData(formData); 
  },
  // BaÅŸarÄ± callback'i
  onSuccess: (result: ApiSuccessResult) => {
    toast.add({ title: 'BaÅŸarÄ±lÄ±!', description: result.message || 'Veri kaydedildi.', color: 'green' });
    // state'i sÄ±fÄ±rla veya yÃ¶nlendirme yap
    // state.name = ''; state.email = ''; 
    // await navigateTo(`/items/${result.id}`);
  },
  // Hata callback'i (opsiyonel, error state'i zaten gÃ¼ncelleniyor)
  onError: (error: IApiError) => {
      console.log("FormHandler onError callback tetiklendi:", error);
      // Alan bazlÄ± hatalarÄ± burada setErrors ile iÅŸleyebiliriz
      // Ã‡Ã¼nkÃ¼ composable'dan gelen error state'i gÃ¼ncellendiÄŸinde burasÄ± Ã§alÄ±ÅŸÄ±r
      if (formRef.value && error.details && typeof error.details === 'object' && error.code === 'VALIDATION_ERROR') {
        const fieldErrors = Object.entries(error.details).map(([key, value]) => ({
            path: key,
            message: Array.isArray(value) ? value.join(', ') : String(value),
        }));
        formRef.value.setErrors(fieldErrors);
      }
      // Ä°steÄŸe baÄŸlÄ±: DiÄŸer hata kodlarÄ±na gÃ¶re Ã¶zel iÅŸlemler
      // if (error.code === '...') { ... }
  }
});

// Alternatif: onError callback kullanmadan error state'ini izleyerek alan hatalarÄ±nÄ± ayarlama
/*
watch(formError, (newError) => {
  if (formRef.value && newError?.details && typeof newError.details === 'object' && newError.code === 'VALIDATION_ERROR') {
      const fieldErrors = Object.entries(newError.details).map(([key, value]) => ({
          path: key,
          message: Array.isArray(value) ? value.join(', ') : String(value),
      }));
      formRef.value.setErrors(fieldErrors);
  } else if (!newError) {
      // Hata temizlendiÄŸinde alan hatalarÄ±nÄ± da temizle
      formRef.value?.clear();
  }
});
*/

</script>
```

## ğŸ“Œ Ã–nemli Notlar

*   **Composable KullanÄ±mÄ±:** Ã–rnek, `useFormHandler` composable'Ä±nÄ±n kullanÄ±mÄ±nÄ± gÃ¶sterir. Bu, component iÃ§indeki gÃ¶nderim mantÄ±ÄŸÄ±nÄ± Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.
*   **Hata YÃ¶netimi:** Composable, `isLoading` ve normalize edilmiÅŸ `error` state'ini yÃ¶netir. Component, bu `error` state'ini kullanarak `<UAlert>` gibi genel hata mesajlarÄ±nÄ± gÃ¶sterebilir. Alan bazlÄ± hatalar (`setErrors`), composable'Ä±n `onError` callback'i iÃ§inde veya `error` state'ini `watch` ederek component tarafÄ±nda yÃ¶netilmelidir.
*   **Alan HatalarÄ±nÄ± Temizleme:** Form gÃ¶nderimi baÅŸlamadan Ã¶nce (`onSubmit` iÃ§inde) veya `error` state'i `null` olduÄŸunda (`watch` bloÄŸunda) `formRef.value?.clear()` Ã§aÄŸrÄ±larak Ã¶nceki alan hatalarÄ±nÄ±n temizlenmesi Ã¶nerilir.
*   **Pinia Action Beklentisi:** `useFormHandler` Ã¶rneÄŸi, `onSubmit` olarak verilen fonksiyonun (Ã¶rn. Pinia action) baÅŸarÄ± durumunda bir sonuÃ§ dÃ¶ndÃ¼rmesini, hata durumunda ise bir hata *fÄ±rlatmasÄ±nÄ±* (throw) bekler. Composable bu hatayÄ± yakalayÄ±p `normalizeError` ile iÅŸler. EÄŸer action hata fÄ±rlatmak yerine `{ success: false, error: ... }` dÃ¶ndÃ¼rÃ¼yorsa, `onSubmit` iÃ§inde bu durum kontrol edilip manuel olarak hata fÄ±rlatÄ±lmalÄ±dÄ±r.

## ğŸ“š BaÅŸvurular

*   [Nuxt UI UForm DokÃ¼mantasyonu](https://ui.nuxt.com/forms/form)
*   [Nuxt UI UAlert DokÃ¼mantasyonu](https://ui.nuxt.com/elements/alert)
*   [Nuxt UI UButton DokÃ¼mantasyonu](https://ui.nuxt.com/elements/button)
*   [Nuxt UI useToast DokÃ¼mantasyonu](https://ui.nuxt.com/overlays/toast)
*   `./form-error-handling.mdc`
*   `../state/pinia-store-structure.mdc`
*   `../../utils/error.ts`
*   `../../composables/useFormHandler.ts` (Yeni eklendi)
