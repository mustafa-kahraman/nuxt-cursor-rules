---
description: 
globs: 
alwaysApply: false
---
# Form GÃ¶nderim Hata YÃ¶netimi KurallarÄ± (Nuxt UI)

## ğŸ¯ Kural Tipi YapÄ±landÄ±rmasÄ±

### Birincil Kural Tipi SeÃ§imi
- [x] Her zaman: TutarlÄ± kullanÄ±cÄ± deneyimi iÃ§in
- [ ] Manuel
- [ ] Otomatik EklenmiÅŸ
- [ ] Ajan TarafÄ±ndan Ä°stenen

type: always
description: `<UForm>` ile gÃ¶nderilen formlarda API'den dÃ¶nen hatalarÄ±n yakalanmasÄ±, iÅŸlenmesi ve kullanÄ±cÄ±ya gÃ¶sterilmesi iÃ§in standartlarÄ± tanÄ±mlar.
globs: components/**/*.vue, pages/**/*.vue

## ğŸ“‹ Sorumluluklar

### Hata Yakalama ve NormalleÅŸtirme
- Form gÃ¶nderim fonksiyonundaki (`@submit` olayÄ±na baÄŸlÄ±) `try...catch` bloÄŸunda API hatalarÄ±nÄ± yakalayÄ±n.
- Yakalanan hatayÄ±, `@pinia-store-structure.mdc` kuralÄ±nda Ã¶nerilen `normalizeError` helper fonksiyonu (veya benzeri) ile standart bir `IApiError { code, message, details? }` formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n.

### Genel Hata GÃ¶sterimi
- API'den dÃ¶nen ve belirli bir forma alanÄ±na ait olmayan genel hatalarÄ± (Ã¶rn. sunucu hatasÄ± - 500, yetkilendirme hatasÄ± - 401/403) formun uygun bir yerinde, genellikle `<UAlert>` bileÅŸeni ile gÃ¶sterin.
- Bu genel hata mesajÄ± iÃ§in ayrÄ± bir `ref` (Ã¶rn. `formError = ref<IApiError | null>(null)`) kullanÄ±n.

### Alan BazlÄ± Hata GÃ¶sterimi (Sunucu TarafÄ± DoÄŸrulama)
- API'nin, belirli alanlara ait doÄŸrulama hatalarÄ±nÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir ÅŸekilde (Ã¶rn. `{ errors: { email: 'Bu e-posta zaten kayÄ±tlÄ±.', name: '...' } }`) dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼ durumlar iÃ§in `<UForm>` bileÅŸeninin `setErrors` metodunu kullanÄ±n.
- API yanÄ±tÄ±ndaki hata yapÄ±sÄ±nÄ± `setErrors`'un beklediÄŸi `[{ path: string, message: string }]` formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n.
- `setErrors` Ã§aÄŸrÄ±sÄ±, ilgili `<UFormGroup>` bileÅŸenlerinin hata mesajlarÄ±nÄ± otomatik olarak gÃ¼ncellemesini saÄŸlar.
- `setErrors` kullanmak iÃ§in `<UForm>` bileÅŸenine bir `ref` (Ã¶rn. `nuxtUiForm`) atamanÄ±z gerekir.

### FarklÄ± Hata SenaryolarÄ±
- **422 (Unprocessable Entity):** Genellikle sunucu tarafÄ± alan doÄŸrulama hatalarÄ±dÄ±r. `setErrors` ile yÃ¶netin.
- **400 (Bad Request):** Genel bir istek hatasÄ± olabilir veya alan bazlÄ± olabilir. API yanÄ±tÄ±na gÃ¶re `UAlert` veya `setErrors` kullanÄ±n.
- **401/403 (Unauthorized/Forbidden):** Genellikle genel bir hata olarak `UAlert` ile gÃ¶sterilir veya kullanÄ±cÄ± login sayfasÄ±na yÃ¶nlendirilir.
- **5xx (Server Error):** Genel bir hata olarak `UAlert` ile gÃ¶sterilir.
- **DiÄŸer Hatalar (Network vb.):** Genel bir hata olarak `UAlert` ile gÃ¶sterilir.

### KullanÄ±cÄ± Geri Bildirimi (`useToast`)
- Hata mesajÄ±nÄ± forma doÄŸrudan yansÄ±tmanÄ±n yanÄ± sÄ±ra, kritik olmayan veya bilgilendirici hatalar iÃ§in Nuxt UI'Ä±n `useToast()` composable'Ä±nÄ± kullanarak bildirim gÃ¶sterebilirsiniz.
- Ã–rneÄŸin, baÅŸarÄ±lÄ± bir iÅŸlem sonrasÄ± veya non-blocking bir hata durumunda kullanÄ±labilir.

### Odak YÃ¶netimi (Ä°steÄŸe BaÄŸlÄ±)
- Sunucu tarafÄ± alan hatasÄ± alÄ±ndÄ±ÄŸÄ±nda, kullanÄ±cÄ± deneyimini iyileÅŸtirmek iÃ§in ilk hatalÄ± alana odaklanmayÄ± dÃ¼ÅŸÃ¼nebilirsiniz. Bu, `<UForm>` referansÄ± Ã¼zerinden ilgili elemana eriÅŸerek yapÄ±labilir (daha ileri seviye bir konudur).

## ğŸ§© Anahtar BileÅŸenler
- `try...catch` bloÄŸu: Hata yakalama.
- `normalizeError`: Hata standardizasyonu.
- `<UAlert>`: Genel hata gÃ¶sterimi.
- `<UForm>` `ref`: `setErrors` metoduna eriÅŸim iÃ§in.
- `setErrors` Metodu: Alan bazlÄ± sunucu hatalarÄ±nÄ± `<UFormGroup>`'lara iletmek iÃ§in.
- `useToast` (Nuxt UI): Bildirim gÃ¶stermek iÃ§in.
- `IApiError` ArayÃ¼zÃ¼: StandartlaÅŸtÄ±rÄ±lmÄ±ÅŸ hata nesnesi.

## ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar

### Gerekli Paketler
- `@nuxt/ui`
- (Ä°lgili formun baÄŸÄ±mlÄ±lÄ±klarÄ±: `vee-validate`, `zod` vs.)

### Gerekli Kurallar
- @form-start.mdc (Bu kural, formun temel kurulumunu varsayar)
- @types-schema-models.mdc (`IApiError` tanÄ±mÄ± iÃ§in)
- @pinia-store-structure.mdc (`normalizeError` fonksiyonu referansÄ± iÃ§in, eÄŸer kullanÄ±lÄ±yorsa)

## âœ… DoÄŸru KullanÄ±m
```vue
<template>
  <UForm
    :schema="formSchema" 
    :state="state" 
    class="space-y-4"
    @submit="onSubmit"
    ref="nuxtUiForm" <!-- setErrors iÃ§in ref eklendi -->
  >
    <!-- Genel Form Hata AlanÄ± (Formun ÃœstÃ¼nde) -->
    <UAlert
      v-if="formError"
      icon="i-heroicons-exclamation-triangle"
      color="red"
      variant="soft"
      :title="formError.message || 'Bir hata oluÅŸtu'"
      :description="formError.details?.field ? `Alan: ${formError.details.field}` : ''" 
      class="mb-4" <!-- Ãœstte olduÄŸu iÃ§in alt boÅŸluk -->
      closable 
      @close="formError = null" <!-- Kapatma butonu -->
    />

    <UFormGroup label="E-posta" name="email" required>
      <UInput v-model="state.email" />
      <!-- Hata otomatik gÃ¶sterilir (hem client hem server/setErrors) -->
    </UFormGroup>

    <UFormGroup label="Åifre" name="password" required>
      <UInput v-model="state.password" type="password" />
    </UFormGroup>

    <UButton type="submit" :loading="loading">
      Kaydet
    </UButton>

  </UForm>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { z } from 'zod';
import { toTypedSchema } from '@vee-validate/zod';
import type { FormSubmitEvent, Form } from '#ui/types';
import type { IApiError } from '@/types/shared.types'; 
import { normalizeError } from '@/utils/errorHelper'; 
const toast = useToast(); // Toast kullanÄ±mÄ± iÃ§in

// --- Åema ve State (@form-start.mdc'den) --- 
const UserFormSchema = z.object({
  email: z.string().email("GeÃ§ersiz e-posta"),
  password: z.string().min(8, "Åifre en az 8 karakter olmalÄ±"),
});
type UserFormData = z.output<typeof UserFormSchema>;
const formSchema = toTypedSchema(UserFormSchema);
const state = reactive<Partial<UserFormData>>({ email: undefined, password: undefined });
// --- --- --- --- --- 

const loading = ref(false);
const formError = ref<IApiError | null>(null); // Genel hata iÃ§in
const nuxtUiForm = ref<Form<UserFormData> | null>(null);

async function onSubmit(event: FormSubmitEvent<UserFormData>) {
  loading.value = true;
  formError.value = null;
  // Ã–nceki alan hatalarÄ±nÄ± temizle (yeni gÃ¶nderim Ã¶ncesi)
  nuxtUiForm.value?.clear(); 

  try {
    await $fetch('/api/register', { method: 'POST', body: event.data });
    toast.add({ title: 'KayÄ±t baÅŸarÄ±lÄ±!', color: 'green' });
    // BaÅŸarÄ±lÄ± iÅŸlem sonrasÄ±...

  } catch (err: unknown) {
    const normalizedError = normalizeError(err);
    console.error("KayÄ±t HatasÄ±:", err); // Orijinal hatayÄ± logla

    // 1. Alan bazlÄ± hatalarÄ± iÅŸle (Ã¶rn. 422 hatasÄ±)
    //    API'nin { errors: { email: 'Bu e-posta zaten kayÄ±tlÄ±.' } } gibi dÃ¶ndÃ¼ÄŸÃ¼nÃ¼ varsayalÄ±m
    const fieldErrors = normalizedError.details?.errors;
    if (fieldErrors && typeof fieldErrors === 'object' && nuxtUiForm.value) {
        const veeErrors = Object.entries(fieldErrors).map(([path, message]) => ({ 
            path: path, // API'den gelen alan adÄ±
            message: Array.isArray(message) ? message.join(', ') : String(message) // MesajÄ±n string olduÄŸundan emin ol
        }));
        nuxtUiForm.value.setErrors(veeErrors);
        // Alan hatasÄ± varsa genel hata gÃ¶stermeyebiliriz veya farklÄ± gÃ¶sterebiliriz
        formError.value = { code: 'VALIDATION_ERROR', message: 'LÃ¼tfen formdaki hatalarÄ± dÃ¼zeltin.' };
        // Ä°lk hatalÄ± alana odaklan (opsiyonel)
        // if (veeErrors.length > 0) { nuxtUiForm.value?.focus(veeErrors[0].path); }
    } else {
        // 2. Genel hatayÄ± gÃ¶ster
        formError.value = normalizedError;
        // Ä°steÄŸe baÄŸlÄ±: Genel hata iÃ§in toast gÃ¶sterimi
        // toast.add({ title: 'Hata!', description: normalizedError.message, color: 'red' });
    }
  } finally {
    loading.value = false;
  }
}
</script>
```

## âŒ YanlÄ±ÅŸ KullanÄ±m
- API'den dÃ¶nen hatalarÄ± yakalamamak (`try...catch` eksikliÄŸi).
- Sunucu tarafÄ± alan hatalarÄ±nÄ± (`setErrors` ile) forma yansÄ±tmamak.
- TÃ¼m hatalarÄ± sadece `console.error` ile loglayÄ±p kullanÄ±cÄ±ya gÃ¶stermemek.
- FarklÄ± hata tÃ¼rleri iÃ§in tutarsÄ±z gÃ¶sterim yÃ¶ntemleri kullanmak.

## ğŸ” Kontrol Listesi
- [ ] Form gÃ¶nderiminde `try...catch` kullanÄ±lÄ±yor mu?
- [ ] Yakalanan hata `normalizeError` ile standartlaÅŸtÄ±rÄ±lÄ±yor mu?
- [ ] Genel hatalar iÃ§in `<UAlert>` veya benzeri bir gÃ¶sterim var mÄ±?
- [ ] Sunucu tarafÄ± alan hatalarÄ± iÃ§in `setErrors` kullanÄ±lÄ±yor mu?
- [ ] `<UForm>` iÃ§in `ref` tanÄ±mlanmÄ±ÅŸ mÄ± (`setErrors` iÃ§in)?
- [ ] Hata mesajlarÄ± kullanÄ±cÄ± iÃ§in anlaÅŸÄ±lÄ±r mÄ±?
- [ ] GerektiÄŸinde `useToast` ile ek geri bildirim veriliyor mu?

## ğŸ“ Kural Ä°Ã§eriÄŸi YÃ¶nergeleri
- API hata yakalama (`try...catch`) ve normalleÅŸtirme (`normalizeError`) adÄ±mlarÄ±nÄ± vurgulayÄ±n.
- Genel hatalarÄ±n `<UAlert>` ile nasÄ±l gÃ¶sterileceÄŸini Ã¶rnekleyin.
- Sunucu tarafÄ± alan hatalarÄ±nÄ±n `setErrors` ile `<UFormGroup>`'lara nasÄ±l iletileceÄŸini detaylandÄ±rÄ±n.
- FarklÄ± HTTP durum kodlarÄ±na gÃ¶re olasÄ± yaklaÅŸÄ±mlarÄ± (alert, setErrors, yÃ¶nlendirme) aÃ§Ä±klayÄ±n.
- `useToast` kullanÄ±mÄ±nÄ± bir seÃ§enek olarak belirtin.

## ğŸ”„ Kural BakÄ±mÄ±
- Nuxt UI, VeeValidate veya kullanÄ±lan HTTP istemcisinin (Ã¶rn. `ofetch`) hata yapÄ±larÄ±ndaki deÄŸiÅŸikliklere gÃ¶re gÃ¼ncelleyin.
- Yeni hata yÃ¶netimi desenleri veya kÃ¼tÃ¼phaneleri Ã§Ä±ktÄ±kÃ§a eklemeler yapÄ±n.

## ğŸ§ª Testler
- Component testleri ile:
  - [ ] BaÅŸarÄ±lÄ± API yanÄ±tÄ± sonrasÄ± hata gÃ¶sterilmediÄŸini test edin.
  - [ ] Genel API hatasÄ± (Ã¶rn. 500) durumunda `<UAlert>`'Ä±n doÄŸru mesajla gÃ¶rÃ¼ndÃ¼ÄŸÃ¼nÃ¼ test edin.
  - [ ] Alan bazlÄ± sunucu hatasÄ± (Ã¶rn. 422) durumunda:
    - Ä°lgili `<UFormGroup>`'un hata mesajÄ±nÄ± gÃ¶sterdiÄŸini test edin (`setErrors` sonrasÄ±).
    - Genel hata alanÄ±nÄ±n (varsa) farklÄ± bir mesaj gÃ¶sterdiÄŸini veya gizlendiÄŸini test edin.
  - [ ] Yetki hatasÄ± (Ã¶rn. 401/403) durumunda beklenen davranÄ±ÅŸÄ±n (alert, yÃ¶nlendirme) gerÃ§ekleÅŸtiÄŸini test edin.
  - [ ] `useToast` Ã§aÄŸrÄ±larÄ±nÄ±n doÄŸru parametrelerle yapÄ±ldÄ±ÄŸÄ±nÄ± (spy kullanarak) test edin.

## ğŸ’¡ Ä°puÃ§larÄ±
- `normalizeError` fonksiyonunu API'nizin dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼ spesifik hata yapÄ±larÄ±na gÃ¶re Ã¶zelleÅŸtirin.
- `setErrors` kullanÄ±rken API'den dÃ¶nen alan adlarÄ±nÄ±n (`path`) `<UFormGroup>` `name` prop'larÄ± ile eÅŸleÅŸtiÄŸinden emin olun.
- KullanÄ±cÄ±ya gÃ¶sterilen hata mesajlarÄ±nÄ±n hem bilgilendirici hem de gÃ¼venli olduÄŸundan (Ã¶rn. hassas bilgi sÄ±zdÄ±rmadÄ±ÄŸÄ±ndan) emin olun.
- Ã‡ok adÄ±mlÄ± formlar veya karmaÅŸÄ±k baÄŸÄ±mlÄ±lÄ±klar iÃ§eren formlar iÃ§in hata yÃ¶netimini daha dikkatli planlayÄ±n.
