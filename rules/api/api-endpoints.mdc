---
description: 
globs: 
alwaysApply: false
---
# API Endpoints KurallarÄ± (NuxtJS)

## ğŸ¯ Kural Tipi YapÄ±landÄ±rmasÄ±

### Birincil Kural Tipi SeÃ§imi
- [ ] Her zaman: Her istekte otomatik olarak uygulanÄ±r (Ã¶rn. kod stili, gÃ¼venlik kontrolleri)
- [x] Manuel: YalnÄ±zca manuel olarak Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda kullanÄ±lÄ±r (Ã¶rn. Ã¶zel kod oluÅŸturma ÅŸablonlarÄ±)
- [ ] Otomatik EklenmiÅŸ: Belirli dosyalar/durumlar iÃ§in otomatik olarak tetiklenir
- [ ] Ajan TarafÄ±ndan Ä°stenen: AI tarafÄ±ndan gerektiÄŸinde Ã§aÄŸrÄ±lÄ±r

type: manual
description: NuxtJS 3+ projelerinde API endpoint'lerinin yapÄ±sÄ±nÄ± ve uygulama standartlarÄ±nÄ± tanÄ±mlar.
globs: server/api/**/*.ts

## ğŸ“‹ Sorumluluklar

### Hata YÃ¶netimi [@error-handling-rules.mdc]
- `h3`'Ã¼n `createError` fonksiyonunu kullanarak standart HTTP hatalarÄ± oluÅŸturun.
- Ã–zel iÅŸ mantÄ±ÄŸÄ± hatalarÄ± iÃ§in belki ayrÄ± hata sÄ±nÄ±flarÄ± kullanÄ±n (bkz: @error-handling-rules.mdc).
- Girdi doÄŸrulama hatalarÄ±nÄ± yÃ¶netin (Ã¶rn. `zod` ile).

### Veri KatmanÄ± [@types-schema-models.mdc]
- VeritabanÄ± iÅŸlemleri iÃ§in belirlenen ORM/metodu kullanÄ±n (Ã¶rn. Prisma, Mongoose).
- `types-schema-models.mdc` iÃ§indeki model ÅŸemasÄ± tanÄ±mlarÄ±na uyun.
- Veri doÄŸrulamasÄ±nÄ± ÅŸemalar kullanarak uygulayÄ±n.

### Ä°stek/YanÄ±t YapÄ±sÄ±
- Endpoint isimlendirmesinde REST prensiplerini takip edin.
- Uygun HTTP metodlarÄ±nÄ± kullanÄ±n (GET/POST/PUT/DELETE vb.).
- TutarlÄ± bir yanÄ±t formatÄ± uygulayÄ±n (Ã¶rn. JSend veya benzeri):
  ```typescript
  // Ã–rnek BaÅŸarÄ±lÄ± YanÄ±t
  {
    status: 'success',
    data: { /* ... veriler ... */ }
  }

  // Ã–rnek Hata YanÄ±tÄ± (createError ile otomatik yÃ¶netilir)
  {
    "statusCode": 400,
    "statusMessage": "Bad Request",
    "message": "Gerekli alan eksik: email"
  }
  ```

### UluslararasÄ±laÅŸtÄ±rma [@i18n-rules.mdc]
- Hata mesajlarÄ± ve diÄŸer metinler iÃ§in i18n mekanizmasÄ±nÄ± kullanÄ±n.

## ğŸ§© Anahtar BileÅŸenler
- Route Handler: `defineEventHandler` kullanarak temel endpoint mantÄ±ÄŸÄ±.
- DoÄŸrulama: Ä°stek verisi doÄŸrulamasÄ± (Ã¶rn. `zod` ile `readValidatedBody`, `getValidatedQuery`).
- Hata Ä°ÅŸleyici: Nuxt'Ä±n yerleÅŸik `h3` hata yÃ¶netimi (`createError`, `throwError`).
- VeritabanÄ± EriÅŸimi: TanÄ±mlanmÄ±ÅŸ veri katmanÄ± kurallarÄ±na gÃ¶re (@types-schema-models.mdc).

## ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar

### Gerekli Paketler
- `h3`: (Nuxt ile gelir)
- `zod`: (Ä°steÄŸe baÄŸlÄ± ama Ã¶nerilen, ÅŸema doÄŸrulamasÄ± iÃ§in)
- VeritabanÄ± istemcisi (Ã¶rn. `@prisma/client`, `mongoose`)

### Gerekli Kurallar
- error-handling-rules.mdc (VarsayÄ±msal)
- types-schema-models.mdc (VarsayÄ±msal)
- i18n-rules.mdc (VarsayÄ±msal)

## âœ… DoÄŸru KullanÄ±m
```typescript
// server/api/users/[id].get.ts
import { User } from '@/server/models/user.model'; // VarsayÄ±msal model
import { z } from 'zod';

export default defineEventHandler(async (event) => {
  const id = getRouterParam(event, 'id');

  // ID'nin geÃ§erli bir formatta olup olmadÄ±ÄŸÄ±nÄ± kontrol et (Ã¶rneÄŸin ObjectId)
  if (!isValidObjectId(id)) { // isValidObjectId varsayÄ±msal bir yardÄ±mcÄ± fonksiyondur
      throw createError({
          statusCode: 400,
          statusMessage: 'Bad Request',
          message: 'GeÃ§ersiz kullanÄ±cÄ± ID formatÄ±.',
      });
  }

  const user = await User.findById(id);

  if (!user) {
    throw createError({
      statusCode: 404,
      statusMessage: 'Not Found',
      message: `KullanÄ±cÄ± bulunamadÄ±: ${id}`,
    });
  }

  // BaÅŸarÄ±lÄ± yanÄ±t (otomatik olarak JSON'a Ã§evrilir)
  return user;
});

// server/api/users.post.ts
import { User } from '@/server/models/user.model'; // VarsayÄ±msal model
import { z } from 'zod';

// Zod ile doÄŸrulama ÅŸemasÄ±
const UserCreateSchema = z.object({
  name: z.string().min(1, "Ä°sim gereklidir"),
  email: z.string().email("GeÃ§ersiz e-posta adresi"),
});

export default defineEventHandler(async (event) => {
  // readValidatedBody, zod ÅŸemasÄ± ile doÄŸrulama yapar ve hata durumunda otomatik 400 dÃ¶ner
  const body = await readValidatedBody(event, (data) => UserCreateSchema.safeParse(data));

  if (!body.success) {
    // Hata detaylarÄ± body.error iÃ§inde bulunur, Nuxt/h3 bunu otomatik yÃ¶netir
    throw createError({
        statusCode: 400,
        statusMessage: 'Validation Error',
        data: body.error.format() // Hata detaylarÄ±nÄ± ekleyebilirsiniz
    });
  }

  // DoÄŸrulanmÄ±ÅŸ veri: body.data
  const newUser = await User.create(body.data);

  // OluÅŸturulan kaynaÄŸÄ±n konumunu baÅŸlÄ±kta belirtmek iyi bir pratiktir
  setHeader(event, 'Location', `/api/users/${newUser.id}`);
  // BaÅŸarÄ±lÄ± yanÄ±t (201 Created)
  setResponseStatus(event, 201);
  return newUser;
});
```

## âŒ YanlÄ±ÅŸ KullanÄ±m
```typescript
// âŒ YANLIÅ: DoÄŸrudan `res.end` veya `res.writeHead` kullanÄ±mÄ±
// Nuxt/h3 yardÄ±mcÄ± fonksiyonlarÄ± (Ã¶rn. `send`, `createError`) kullanÄ±lmalÄ±
export default defineEventHandler(async (event) => {
  // event.node.res.statusCode = 404; // YANLIÅ
  // event.node.res.end('Not Found'); // YANLIÅ

  throw createError({ statusCode: 404, message: 'BulunamadÄ±' }); // DOÄRU
});

// âŒ YANLIÅ: TutarsÄ±z yanÄ±t formatÄ±
export default defineEventHandler(async (event) => {
    const data = { user: { id: 1, name: "Test" } };
    // return { data: data }; // TutarlÄ± bir yapÄ± (Ã¶rn. JSend) kullanÄ±lmalÄ± veya doÄŸrudan obje dÃ¶nÃ¼lmeli
    return data.user; // DoÄŸrudan obje dÃ¶nmek genellikle yeterlidir
});

// âŒ YANLIÅ: Hata yÃ¶netimini manuel yapmak
export default defineEventHandler(async (event) => {
  try {
    // ... iÅŸlem ...
  } catch (error) {
    // event.node.res.statusCode = 500; // YANLIÅ
    // return { error: 'Sunucu HatasÄ±' }; // YANLIÅ
    throw createError({ statusCode: 500, message: 'Ä°Ã§ Sunucu HatasÄ±', cause: error }); // DOÄRU
  }
});
```

## ğŸ” Kontrol Listesi

### Kod Kalitesi
- [ ] Uygun HTTP metodlarÄ± kullanÄ±lÄ±yor mu (GET, POST, PUT, DELETE vb.)?
- [ ] Girdi doÄŸrulamasÄ± uygulanÄ±yor mu (`readValidatedBody`, `getValidatedQuery`)?
- [ ] Hata yÃ¶netimi iÃ§in `createError` veya `throwError` kullanÄ±lÄ±yor mu?
- [ ] BaÅŸarÄ±lÄ± yanÄ±tlar iÃ§in uygun HTTP durum kodlarÄ± ayarlanÄ±yor mu (Ã¶rn. 201 for POST)?
- [ ] RESTful isimlendirme kurallarÄ±na uyuluyor mu?
- [ ] Asenkron iÅŸlemler doÄŸru ÅŸekilde yÃ¶netiliyor mu (`async/await`)?

### Teknik Gereksinimler
- [ ] Ä°stek gÃ¶vdesi/parametreleri doÄŸrulanÄ±yor mu?
- [ ] @error-handling-rules.mdc desenleri kullanÄ±lÄ±yor mu?
- [ ] Uygun TypeScript tipleri kullanÄ±lÄ±yor mu?
- [ ] VeritabanÄ± iÅŸlemleri ilgili kurallara (@types-schema-models.mdc) uygun mu?

## ğŸ“ Kural Ä°Ã§eriÄŸi YÃ¶nergeleri
- Endpoint tanÄ±mÄ± ve rota yapÄ±sÄ± ile baÅŸlayÄ±n.
- `zod` veya benzeri bir kÃ¼tÃ¼phane ile doÄŸrulama Ã¶rnekleri ekleyin.
- `h3`'Ã¼n `createError` ve yardÄ±mcÄ± fonksiyonlarÄ± ile hata yÃ¶netimi desenlerini gÃ¶sterin.
- YanÄ±t formatlarÄ±nÄ± belgeleyin (Nuxt genellikle doÄŸrudan obje dÃ¶nÃ¼ÅŸÃ¼nÃ¼ yÃ¶netir).
- TypeScript tiplerini ekleyin.

## ğŸ”„ Kural BakÄ±mÄ±
- Yeni Nuxt/h3 sÃ¼rÃ¼mleri Ã§Ä±ktÄ±kÃ§a gÃ¼ncelleyin.
- GerektiÄŸinde yeni doÄŸrulama desenleri ekleyin.
- Yeni hata durumlarÄ± iÃ§in hata yÃ¶netimini gÃ¼ncelleyin.
- GÃ¼venlik en iyi uygulamalarÄ±nÄ± gÃ¼ncel tutun.

## ğŸ§ª Testler
### Birim Testleri
- [ ] Rota parametrelerini test edin (`getRouterParam`).
- [ ] Ä°stek doÄŸrulamasÄ±nÄ± test edin (`readValidatedBody`, `getValidatedQuery`).
- [ ] Hata yanÄ±tlarÄ±nÄ± test edin (`createError`).
- [ ] BaÅŸarÄ±lÄ± yanÄ±tlarÄ± ve durum kodlarÄ±nÄ± test edin.

### Entegrasyon Testleri
- [ ] VeritabanÄ± iÅŸlemleriyle test edin.
- [ ] Varsa kimlik doÄŸrulama ile test edin.
- [ ] DiÄŸer servislerle etkileÅŸimi test edin.

## ğŸ’¡ Ä°puÃ§larÄ±
- Uygun HTTP durum kodlarÄ±nÄ± kullanÄ±n.
- Halka aÃ§Ä±k endpoint'ler iÃ§in hÄ±z sÄ±nÄ±rlamasÄ± (rate limiting) uygulayÄ±n.
- GeliÅŸtirme ortamÄ±nda istek loglamasÄ± ekleyin (`h3`'Ã¼n kendi loglama mekanizmalarÄ± olabilir).
- Endpoint'leri odaklanmÄ±ÅŸ ve tek amaÃ§lÄ± tutun.
- Ä°stek/yanÄ±t iÃ§in uygun TypeScript tiplerini kullanÄ±n.
- Hata ayÄ±klamayÄ± kolaylaÅŸtÄ±rmak iÃ§in `cause` seÃ§eneÄŸi ile orijinal hatayÄ± `createError` iÃ§ine ekleyin.

## âœ… DoÄŸru KullanÄ±m Ã–rnekleri

### 1. Veri Listeleme (GET `/api/users`)

```typescript
// server/api/users/index.get.ts
import { defineEventHandler } from 'h3';
import { listUsers } from '~/server/services/userService'; // Ã–rnek servis

export default defineEventHandler(async (event) => {
  try {
    // TODO: Yetkilendirme kontrolÃ¼ eklenecek
    // TODO: Sayfalama parametreleri alÄ±nacak (query)
    const users = await listUsers(/* { page, limit } */);
    return { data: users }; // BaÅŸarÄ±lÄ± yanÄ±t
  } catch (error: any) {
    // Hata durumunda standart formatta yanÄ±t hazÄ±rla
    // Nuxt 3 otomatik olarak uygun status kodunu ayarlayabilir
    // veya createError kullanabiliriz.
    throw createError({
      statusCode: error.statusCode || 500,
      statusMessage: error.statusMessage || 'KullanÄ±cÄ±lar listelenirken bir hata oluÅŸtu.',
      // normalizeError tarafÄ±ndan okunacak detaylar
      data: {
        code: error.code || 'USER_LIST_ERROR',
        message: error.message || 'KullanÄ±cÄ±lar listelenirken bir hata oluÅŸtu.',
        details: error.details // Varsa ek detaylar (Ã¶rn. stack trace dev modunda)
      }
    });
  }
});
```

### 2. Tek Veri Getirme (GET `/api/users/[id].get.ts`)

```typescript
// server/api/users/[id].get.ts
import { defineEventHandler, getRouterParam } from 'h3';
import { getUserById } from '~/server/services/userService';

export default defineEventHandler(async (event) => {
  const userId = getRouterParam(event, 'id');
  if (!userId) {
      throw createError({ statusCode: 400, statusMessage: 'KullanÄ±cÄ± ID eksik.', data: { code: 'MISSING_PARAM', message: 'KullanÄ±cÄ± ID parametresi eksik.' } });
  }

  try {
    // TODO: Yetkilendirme kontrolÃ¼
    const user = await getUserById(userId);
    if (!user) {
        throw createError({ statusCode: 404, statusMessage: 'KullanÄ±cÄ± bulunamadÄ±.', data: { code: 'NOT_FOUND', message: `ID'si ${userId} olan kullanÄ±cÄ± bulunamadÄ±.` } });
    }
    return { data: user };
  } catch (error: any) {
     throw createError({
      statusCode: error.statusCode || 500,
      statusMessage: error.statusMessage || 'KullanÄ±cÄ± getirilirken bir hata oluÅŸtu.',
      data: {
        code: error.code || 'USER_FETCH_ERROR',
        message: error.message || 'KullanÄ±cÄ± getirilirken bir hata oluÅŸtu.',
        details: error.details 
      }
    });
  }
});
```

### 3. Veri OluÅŸturma (POST `/api/users`)

```typescript
// server/api/users/index.post.ts
import { defineEventHandler, readBody } from 'h3';
import { z } from 'zod';
import { createUser } from '~/server/services/userService';
import { userCreateSchema } from '~/server/schemas/userSchemas'; // Ã–rnek Zod ÅŸemasÄ±

export default defineEventHandler(async (event) => {
  try {
    // TODO: Yetkilendirme
    const body = await readBody(event);
    
    // Sunucu tarafÄ± doÄŸrulama (Zod ile)
    const validationResult = userCreateSchema.safeParse(body);
    if (!validationResult.success) {
        throw createError({
            statusCode: 400, 
            statusMessage: 'DoÄŸrulama hatasÄ±', 
            data: { 
                code: 'VALIDATION_ERROR', 
                message: 'GÃ¶nderilen veriler geÃ§ersiz.', 
                // Alan bazlÄ± hatalarÄ± normalizeError'Ä±n iÅŸlemesi iÃ§in details'e ekle
                details: validationResult.error.flatten().fieldErrors 
            } 
        });
    }

    const newUser = await createUser(validationResult.data);
    // BaÅŸarÄ±lÄ± oluÅŸturma yanÄ±tÄ± (genellikle oluÅŸturulan kaynaÄŸÄ±n kendisi veya ID'si)
    event.node.res.statusCode = 201; // Created status kodu
    return { data: newUser }; 

  } catch (error: any) {
     // Zaten createError ile fÄ±rlatÄ±lanlar veya diÄŸer hatalar
     if (error.data?.code) { // EÄŸer zaten bizim formatÄ±mÄ±zdaysa tekrar sarmalama
        throw error;
     }
     throw createError({
      statusCode: error.statusCode || 500,
      statusMessage: error.statusMessage || 'KullanÄ±cÄ± oluÅŸturulurken bir hata oluÅŸtu.',
      data: {
        code: error.code || 'USER_CREATE_ERROR',
        message: error.message || 'KullanÄ±cÄ± oluÅŸturulurken bir hata oluÅŸtu.',
        details: error.details 
      }
    });
  }
});
```

## ğŸ“ Ã–nemli Notlar

*   **BaÅŸarÄ± YanÄ±tlarÄ±:** BaÅŸarÄ±lÄ± yanÄ±tlar genellikle `{ data: ... }` formatÄ±nda olmalÄ±dÄ±r. Bu, istemci tarafÄ±nda (`$fetch`) veriye tutarlÄ± bir ÅŸekilde eriÅŸimi kolaylaÅŸtÄ±rÄ±r.
*   **Hata YanÄ±tlarÄ±:**
    *   Hatalar, Nuxt 3'Ã¼n `createError` yardÄ±mcÄ± fonksiyonu kullanÄ±larak fÄ±rlatÄ±lmalÄ±dÄ±r.
    *   `createError` iÃ§indeki `data` alanÄ±, istemcideki `normalizeError` fonksiyonunun beklediÄŸi `IApiError` formatÄ±na uygun olmalÄ±dÄ±r (`{ code: string, message: string, details?: any }`).
    *   `statusCode` (Ã¶rn. 400, 404, 500) HTTP durumunu belirtir.
    *   `data.code` hatanÄ±n programatik olarak iÅŸlenmesini saÄŸlar (Ã¶rn. `'VALIDATION_ERROR'`, `'AUTH_REQUIRED'`, `'NOT_FOUND'`).
    *   `data.message` kullanÄ±cÄ±ya gÃ¶sterilebilecek veya loglanacak mesajdÄ±r.
    *   `data.details` ek bilgiler iÃ§erir. Ã–zellikle **doÄŸrulama hatalarÄ±nda (`VALIDATION_ERROR`)**, Zod'un `flatten().fieldErrors` sonucu gibi, alan adlarÄ±nÄ± anahtar, hata mesajlarÄ±nÄ± deÄŸer olarak iÃ§eren bir obje olmalÄ±dÄ±r. Bu, `useFormHandler` veya `displayFormError`'Ä±n `setErrors` ile alanlarÄ± iÅŸaretlemesini saÄŸlar.
*   **DoÄŸrulama:** Sunucu tarafÄ± doÄŸrulamalar (Zod veya baÅŸka bir kÃ¼tÃ¼phane ile) API katmanÄ±nda yapÄ±lmalÄ± ve `VALIDATION_ERROR` kodu ile uygun `details` objesi dÃ¶ndÃ¼rÃ¼lmelidir.
*   **Servis KatmanÄ±:** VeritabanÄ± iÅŸlemleri ve iÅŸ mantÄ±ÄŸÄ± ayrÄ± servis fonksiyonlarÄ±na (Ã¶rn. `~/server/services/...`) taÅŸÄ±nmalÄ±dÄ±r. API endpoint'leri sadece istek/yanÄ±t iÅŸleme ve servis Ã§aÄŸÄ±rma ile ilgilenmelidir.

